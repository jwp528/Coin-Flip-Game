<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    
    <!-- Primary Meta Tags -->
    <title>Coin Flip Game - Unlock Rare Coins & Super Flips | Free Online Game</title>
    <meta name="title" content="Coin Flip Game - Unlock Rare Coins & Super Flips | Free Online Game" />
    <meta name="description" content="Play the ultimate interactive coin flipping game! Unlock rare zodiac coins, perform super flips with double unlock chances, and enjoy stunning 3D animations. Works offline as a PWA!" />
    <meta name="keywords" content="coin flip, coin toss, flip coin, coin game, unlock coins, zodiac coins, super flip, coin flip game, interactive game, PWA game, offline game" />
    <meta name="author" content="Coin Flip Game" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="English" />
    <meta name="revisit-after" content="7 days" />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://coinflipgame.app/" />
    <meta property="og:title" content="Coin Flip Game - Unlock Rare Coins & Super Flips" />
    <meta property="og:description" content="Experience the most addictive coin flipping game! Unlock rare zodiac-themed coins, perform super flips, and compete for achievements. Install now and play offline!" />
    <meta property="og:image" content="https://coinflipgame.app/og-image.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content="Coin Flip Game" />
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://coinflipgame.app/" />
    <meta property="twitter:title" content="Coin Flip Game - Unlock Rare Coins & Super Flips" />
    <meta property="twitter:description" content="The ultimate coin flipping experience with unlockable coins, super flips, and stunning animations. Play now!" />
    <meta property="twitter:image" content="https://coinflipgame.app/twitter-image.png" />
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Coin Flip" />
    <meta name="application-name" content="Coin Flip Game" />
    <meta name="msapplication-TileColor" content="#0f172a" />
    <meta name="msapplication-TileImage" content="/icons/icon-144x144.png" />
    <meta name="msapplication-config" content="/browserconfig.xml" />
    <meta name="theme-color" content="#667eea" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/icon-120x120.png" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="shortcut icon" href="/favicon.ico" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://coinflipgame.app/" />
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    
    <!-- Base -->
    <base href="/" />
    
    <!-- Stylesheets with cache busting -->
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css?v=1.2.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="app.css?v=1.2.0" />
    <link rel="stylesheet" href="CoinFlipGame.App.styles.css?v=1.2.0" />
    
    <!-- Structured Data (JSON-LD) for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Coin Flip Game",
      "description": "Interactive coin flipping game with unlockable rare coins, super flips, and stunning 3D animations. Play online or offline!",
      "url": "https://coinflipgame.app/",
      "applicationCategory": "GameApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "1250"
      },
      "author": {
        "@type": "Organization",
        "name": "Coin Flip Game"
      },
      "screenshot": "https://coinflipgame.app/screenshots/gameplay-1.png",
      "featureList": [
        "Unlock rare zodiac-themed coins",
        "Perform super flips with enhanced effects",
        "Track your flip statistics and streaks",
        "Beautiful 3D coin animations",
        "Works offline as Progressive Web App",
        "Mobile-optimized touch controls"
      ]
    }
    </script>
    
    <style>
        /* Splash Screen Styles */
        #loading-splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background:
                radial-gradient(ellipse at 20% 30%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            overflow: hidden;
        }

        #loading-splash::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                repeating-linear-gradient(45deg, transparent, transparent 100px, rgba(255, 255, 255, 0.02) 100px, rgba(255, 255, 255, 0.02) 200px),
                repeating-linear-gradient(-45deg, transparent, transparent 100px, rgba(255, 255, 255, 0.02) 100px, rgba(255, 255, 255, 0.02) 200px);
            opacity: 0.5;
            pointer-events: none;
        }

        #loading-splash.loaded {
            opacity: 0;
            pointer-events: none;
        }

        .splash-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
            position: relative;
            z-index: 1;
        }

        .splash-coin {
            width: 120px;
            height: 120px;
            position: relative;
            transform-style: preserve-3d;
            animation: splashCoinFlip 2s ease-in-out infinite;
        }

        @keyframes splashCoinFlip {
            0%,
            100% {
                transform: translateY(0) rotateY(0deg);
            }

            25% {
                transform: translateY(-30px) rotateY(180deg);
            }

            50% {
                transform: translateY(0) rotateY(360deg);
            }

            75% {
                transform: translateY(-30px) rotateY(540deg);
            }
        }

        .splash-coin-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            box-shadow:
                0 8px 25px rgba(0, 0, 0, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.6),
                inset 0 -2px 0 rgba(0, 0, 0, 0.3);
            border: 4px solid #daa520;
            overflow: hidden;
        }

        .splash-coin-face img {
            width: 90%;
            height: 90%;
            object-fit: contain;
            user-select: none;
            -webkit-user-drag: none;
            pointer-events: none;
        }

        .splash-coin-back {
            transform: rotateY(180deg);
        }

        .splash-shine {
            position: absolute;
            width: 60%;
            height: 60%;
            background: radial-gradient(
                circle,
                rgba(255, 255, 255, 0.9) 0%,
                rgba(255, 255, 255, 0.5) 40%,
                transparent 70%
            );
            border-radius: 50%;
            filter: blur(12px);
            animation: splashShine 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 2;
        }

        @keyframes splashShine {
            0%,
            100% {
                transform: translate(20%, -20%);
            }

            50% {
                transform: translate(-20%, 20%);
            }
        }

        .splash-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            letter-spacing: 3px;
            animation: splashFadeIn 1s ease-in-out;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .splash-loading {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 3px;
            animation: splashPulse 1.5s ease-in-out infinite;
            font-weight: 600;
        }

        @keyframes splashFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes splashPulse {
            0%,
            100% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }
        }

        .splash-dots::after {
            content: '';
            animation: splashDots 1.5s steps(4, end) infinite;
        }

        @keyframes splashDots {
            0%,
            20% {
                content: '';
            }

            40% {
                content: '.';
            }

            60% {
                content: '..';
            }

            80%,
            100% {
                content: '...';
            }
        }
    </style>
</head>

<body>
    <!-- Loading Splash Screen -->
    <div id="loading-splash">
        <div class="splash-container">
            <div class="splash-coin">
                <div class="splash-coin-face">
                    <div class="splash-shine"></div>
                    <img src="/img/coins/logo.png" alt="Coin Logo" />
                </div>
                <div class="splash-coin-face splash-coin-back">
                    <div class="splash-shine"></div>
                    <img src="/img/coins/logo.png" alt="Coin Logo" />
                </div>
            </div>
            <h1 class="splash-title">COIN FLIP</h1>
            <div class="splash-loading">
                LOADING<span class="splash-dots"></span>
            </div>
        </div>
    </div>

    <!-- Blazor App -->
    <div id="app"></div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">üóô</a>
    </div>

    <!-- Load JavaScript libraries with cache busting -->
    <script src="js/cachemanager.js?v=1.2.0"></script>
    <script src="js/coinhelpers.js?v=1.2.0"></script>
    <script src="js/coinpreviewmodal.js?v=1.2.0"></script>
    <script src="js/particles.js?v=1.2.0"></script>
    <script src="js/physics.js?v=1.2.0"></script>
    <script src="js/audio.js?v=1.2.0"></script>
    <script src="_framework/blazor.webassembly.js" autostart="false"></script>

    <script>
        // Cache management functions
        window.clearCachesAndReload = async function() {
            try {
                // Clear all caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }
                
                // Unregister service workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(reg => reg.unregister()));
                }
                
                // Clear local storage version marker
                localStorage.removeItem('app_last_version');
                
                // Hard reload
                window.location.reload(true);
            } catch (err) {
                console.error('Error clearing caches:', err);
                // Fallback to hard reload
                window.location.reload(true);
            }
        };
        
        // Check for service worker updates
        window.checkForServiceWorkerUpdate = async function() {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        await registration.update();
                    }
                } catch (err) {
                    console.error('Error checking for updates:', err);
                }
            }
        };
        
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js?v=1.2.0')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('New version available! Please refresh.');
                                    // Notify user of update
                                    if (window.DotNet) {
                                        window.DotNet.invokeMethodAsync('CoinFlipGame.App', 'OnUpdateAvailable');
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed:', err);
                    });
            });
        }

        // ERROR BOUNDARY: Handle Blazor startup failures
        let blazorStartAttempts = 0;
        const MAX_START_ATTEMPTS = 3;
        
        async function startBlazorWithRetry() {
            try {
                blazorStartAttempts++;
                console.log(`[Blazor] Starting Blazor (attempt ${blazorStartAttempts}/${MAX_START_ATTEMPTS})...`);
                
                await Blazor.start({
                    loadBootResource: function (type, name, defaultUri, integrity) {
                        // Log resource loading for debugging
                        console.log(`[Blazor] Loading ${type}: ${name}`);
                        
                        // Return default URI - let browser handle the request
                        // The service worker will use network-first for _framework files
                        return defaultUri;
                    }
                });
                
                console.log('[Blazor] Started successfully');
                
                // Hide splash screen after successful start
                setTimeout(() => {
                    const splash = document.getElementById('loading-splash');
                    if (splash) {
                        splash.classList.add('loaded');
                        setTimeout(() => {
                            splash.remove();
                        }, 500);
                    }
                }, 300);
                
            } catch (error) {
                console.error('[Blazor] Startup error:', error);
                
                // Check if it's the specific mono_download_assets error
                if (error.message && error.message.includes('mono_download_assets')) {
                    console.error('[Blazor] Detected mono_download_assets error - this is likely a cache corruption issue');
                }
                
                // Retry logic
                if (blazorStartAttempts < MAX_START_ATTEMPTS) {
                    console.log(`[Blazor] Retrying in 2 seconds...`);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return startBlazorWithRetry();
                } else {
                    // All retries failed - show error and offer to clear cache
                    console.error('[Blazor] All startup attempts failed');
                    showBootFailureMessage(error);
                }
            }
        }
        
        function showBootFailureMessage(error) {
            const splash = document.getElementById('loading-splash');
            if (splash) {
                splash.innerHTML = `
                    <div class="splash-container" style="max-width: 500px; padding: 20px; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <h2 style="color: white; margin-bottom: 20px;">Unable to Start App</h2>
                        <p style="color: rgba(255,255,255,0.8); margin-bottom: 20px; line-height: 1.6;">
                            The app failed to load. This is usually caused by cached files from a previous version.
                        </p>
                        <button onclick="window.clearCachesAndReload()" 
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                       color: white; 
                                       border: none; 
                                       padding: 15px 30px; 
                                       border-radius: 8px; 
                                       font-size: 16px; 
                                       font-weight: 600; 
                                       cursor: pointer;
                                       margin: 10px;
                                       box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                            Clear Cache & Reload
                        </button>
                        <button onclick="window.location.reload(true)" 
                                style="background: rgba(255,255,255,0.1); 
                                       color: white; 
                                       border: 2px solid rgba(255,255,255,0.3); 
                                       padding: 15px 30px; 
                                       border-radius: 8px; 
                                       font-size: 16px; 
                                       font-weight: 600; 
                                       cursor: pointer;
                                       margin: 10px;">
                            Try Again
                        </button>
                        <details style="margin-top: 30px; text-align: left; color: rgba(255,255,255,0.6); font-size: 12px;">
                            <summary style="cursor: pointer; margin-bottom: 10px;">Technical Details</summary>
                            <pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap;">${error.message || error.toString()}</pre>
                        </details>
                    </div>
                `;
            }
        }

        // Start Blazor with error handling
        startBlazorWithRetry();

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install button or prompt
            console.log('PWA install prompt available');
        });

        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            deferredPrompt = null;
        });
    </script>
</body>

</html>
