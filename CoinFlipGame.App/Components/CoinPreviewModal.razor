@using CoinFlipGame.App.Models
@using CoinFlipGame.App.Services
@using Microsoft.AspNetCore.Components.Web

<div class="coin-preview-overlay @(IsVisible ? "visible" : "")" @onclick="OnClose">
    <div class="coin-preview-modal" @onclick:stopPropagation="true">
        <button class="preview-close-btn" @onclick="OnClose">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        
        <div class="preview-content">
            <!-- TCG Card Layout: Coin at Top -->
            <div class="preview-coin-container">
                <div class="preview-coin"
                     @ref="previewCoinElement"
                     @onpointerdown="OnPointerDown"
                     @onpointermove="OnPointerMove"
                     @onpointerup="OnPointerUp"
                     @onpointercancel="OnPointerCancel"
                     style="@GetCoinTransform()">
                    <div class="preview-coin-face">
                        <div class="preview-coin-shine" style="@GetShineTransform()"></div>
                        @if (CoinImage != null)
                        {
                            <img src="@CoinImage.Path" alt="@CoinImage.DisplayName" draggable="false" />
                        }
                    </div>
                </div>
            </div>
            
            <p class="preview-subtitle">Drag to rotate</p>
            
            <!-- TCG Card Stats Section -->
            @if (CoinImage != null)
            {
                <div class="preview-card-frame">
                    <!-- Card Header -->
                    <div class="card-header">
                        <h3 class="card-title">@CoinImage.DisplayName</h3>
                        @if (CoinImage.UnlockCondition != null)
                        {
                            <div class="card-rarity rarity-@CoinImage.UnlockCondition.Rarity.ToString().ToLower()">
                                @CoinImage.UnlockCondition.Rarity
                            </div>
                        }
                    </div>
                    
                    <!-- Unlock Condition -->
                    @if (CoinImage.UnlockCondition != null)
                    {
                        <div class="card-section">
                            <div class="section-header">
                                <span class="section-icon">??</span>
                                <span class="section-label">How to Unlock</span>
                            </div>
                            <div class="section-content">
                                <p class="unlock-description">@CoinImage.UnlockCondition.Description</p>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="card-section">
                            <div class="section-header">
                                <span class="section-icon">??</span>
                                <span class="section-label">Availability</span>
                            </div>
                            <div class="section-content">
                                <p class="unlock-description">Always Unlocked</p>
                            </div>
                        </div>
                    }
                    
                    <!-- Flavor Text -->
                    @if (!string.IsNullOrEmpty(CoinImage.UnlockCondition?.FlavorText))
                    {
                        <div class="card-section flavor-section">
                            <div class="flavor-quote-mark">"</div>
                            <p class="flavor-text">@CoinImage.UnlockCondition.FlavorText</p>
                            <div class="flavor-quote-mark">"</div>
                        </div>
                    }
                    
                    <!-- Stats Footer -->
                    <div class="card-footer">
                        @{
                            var unlockDate = UnlockProgress.GetUnlockTimestamp(CoinImage.Path);
                            var timesLanded = UnlockProgress.GetCoinLandCount(CoinImage.Path);
                        }
                        
                        <div class="footer-stat">
                            <span class="footer-icon">??</span>
                            <span class="footer-label">Landed</span>
                            <span class="footer-value">@timesLanded</span>
                        </div>
                        
                        @if (unlockDate.HasValue)
                        {
                            <div class="footer-stat">
                                <span class="footer-icon">??</span>
                                <span class="footer-label">Unlocked</span>
                                <span class="footer-value">@FormatUnlockDate(unlockDate.Value)</span>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>
