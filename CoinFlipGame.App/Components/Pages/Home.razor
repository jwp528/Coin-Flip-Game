@page "/"

<PageTitle>Coin Flip Game</PageTitle>

<div class="coin-flip-game" 
     @onpointermove="OnPointerMove"
     @onpointerup="OnPointerUp"
     @onpointercancel="OnPointerCancel">
    
    <!-- Mobile Game Style Stats -->
    <div class="stats-container">
        <!-- Heads Counter - Top Left -->
        <div class="stat-counter heads-counter" @onclick='() => OpenCoinSelector("heads")'>
            <img src="@selectedHeadsImage" alt="Heads" class="counter-icon" />
            <span class="counter-value">@headsCount</span>
        </div>
        
        <!-- Tails Counter - Top Right -->
        <div class="stat-counter tails-counter" @onclick='() => OpenCoinSelector("tails")'>
            <img src="@selectedTailsImage" alt="Tails" class="counter-icon" />
            <span class="counter-value">@tailsCount</span>
        </div>
        
        <!-- Streak Counter - Top Center -->
        @if (currentStreak > 3)
        {
            <div class="streak-counter">
                <span class="streak-icon">🔥</span>
                <span class="streak-value">@currentStreak</span>
            </div>
        }
    </div>
    
    <!-- Main Coin Container -->
    <div class="coin-container">
        <div class="coin-glow"></div>
        <div @ref="coinElement" class="coin @flipResult @(isDragging ? "dragging" : "")" 
             @onclick="HandleClick"
             @onpointerdown="OnPointerDown"
             style="@GetCoinTransform()">
            <div class="coin-face @(showLandingFlash ? "landing-flash" : "")">
                <div class="coin-shine" style="@GetShineTransform()"></div>
                <div class="coin-inner-ring"></div>
                <img src="@faceShowing" alt="Coin" draggable="false" />
            </div>
        </div>
    </div>
    
    <!-- Achievement Label - Passive Under Playing Area -->
    @if (showAchievement)
    {
        <div class="achievement-label">
            <span class="achievement-icon">🎉</span>
            <span class="achievement-text">@achievementText</span>
        </div>
    }
    
    <!-- Total Flips Counter -->
    <div class="total-flips">
        <span class="total-label">Total Flips</span>
        <span class="total-value">@(headsCount + tailsCount)</span>
    </div>
</div>

<!-- Coin Selector Modal -->
<CoinSelector 
    IsVisible="@showCoinSelector" 
    Side="@selectingFor"
    AvailableCoins="@availableCoins"
    OnClose="@CloseCoinSelector"
    OnCoinSelected="@SelectCoin" />

<script>
    window.coinDragHandler = {
        coinElement: null,
        
        startDrag: function() {
            this.coinElement = document.querySelector('.coin');
            if (this.coinElement) {
                // Remove any existing transitions for immediate response
                this.coinElement.style.transition = 'none';
            }
        },
        
        updateTransform: function(rotationX, rotationY) {
            if (this.coinElement && !this.coinElement.classList.contains('flip-heads') && !this.coinElement.classList.contains('flip-tails')) {
                // Use requestAnimationFrame for smooth, synchronized updates
                requestAnimationFrame(() => {
                    if (this.coinElement) {
                        this.coinElement.style.transform = `rotateX(${rotationX.toFixed(2)}deg) rotateY(${rotationY.toFixed(2)}deg)`;
                    }
                });
            }
        },
        
        resetTransform: function() {
            if (this.coinElement) {
                // Re-enable transitions for smooth return to neutral
                this.coinElement.style.transition = 'transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
                this.coinElement.style.transform = 'rotateX(0deg) rotateY(0deg)';
            }
        },
        
        clearTransform: function() {
            if (this.coinElement) {
                // Clear inline styles completely to return to neutral
                this.coinElement.style.transform = '';
                this.coinElement.style.transition = '';
            }
        }
    };
</script>
