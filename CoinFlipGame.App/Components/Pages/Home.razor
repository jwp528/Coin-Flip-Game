@page "/{referrer?}"
@using CoinFlipGame.App.Models
@using CoinFlipGame.App.Models.Unlocks

<HeadContent>
    <title>Coin Flip Game</title>
</HeadContent>

<div class="coin-flip-game" 
     @onpointermove="OnPointerMove"
     @onpointerup="OnPointerUp"
     @onpointercancel="OnPointerCancel">
    
    <!-- Control Buttons - Header on Desktop -->
    <div class="control-buttons-header">
        <button class="control-btn" @onclick="ToggleSound" title="@(isSoundEnabled ? "Sound On" : "Sound Off")">
            @if (isSoundEnabled)
            {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                </svg>
            }
            else
            {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <line x1="23" y1="9" x2="17" y2="15"></line>
                    <line x1="17" y1="9" x2="23" y2="15"></line>
                </svg>
            }
        </button>
        <button class="control-btn @(!isHapticsSupported ? "has-warning" : "")" @onclick="ToggleHaptics" title="@(isHapticsEnabled ? "Haptics On" : "Haptics Off")">
            @if (!isHapticsSupported)
            {
                <span class="warning-badge">!</span>
            }
            @if (isHapticsEnabled)
            {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 3v18h6l6-6V9L9 3H3z"></path>
                    <path d="M21 12c0-2.5-1-4.5-3-6"></path>
                    <path d="M18 12c0-1.5-.5-2.5-1.5-3.5"></path>
                </svg>
            }
            else
            {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 3v18h6l6-6V9L9 3H3z"></path>
                    <line x1="23" y1="9" x2="17" y2="15"></line>
                    <line x1="17" y1="9" x2="23" y2="15"></line>
                </svg>
            }
        </button>
        <a class="control-btn" href="https://github.com/jwp528/Coin-Flip-Game" target="_blank" rel="noopener noreferrer" title="View on GitHub">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
        </a>
        <button class="control-btn" @onclick="OpenAboutModal" title="About">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        </button>
    </div>
    
    <!-- Mobile Game Style Stats -->
    <div class="stats-container">
        <!-- Heads Counter - Top Left -->
        <div class="stat-counter heads-counter" @onclick='() => OpenCoinSelector("heads")'>
            <div class="counter-content">
                <img src="@selectedHeadsImage" alt="Heads" class="counter-icon" />
                <div class="counter-info">
                    <div class="counter-label">Heads</div>
                    <span class="counter-value">@headsCount</span>
                </div>
            </div>
        </div>
        
        <!-- Tails Counter - Top Right -->
        <div class="stat-counter tails-counter" @onclick='() => OpenCoinSelector("tails")'>
            <div class="counter-content">
                <img src="@selectedTailsImage" alt="Tails" class="counter-icon" />
                <div class="counter-info">
                    <div class="counter-label">Tails</div>
                    <span class="counter-value">@tailsCount</span>
                </div>
            </div>
        </div>
        
        <!-- Streak Counter - Top Center -->
        @if (currentStreak > 2)
        {
            <div class="streak-counter">
                <span class="streak-icon">🔥</span>
                <span class="streak-value">@currentStreak</span>
            </div>
        }
    </div>
    
    <!-- Main Coin Container -->
    <div class="coin-container">
        <div class="coin-glow"></div>
        
        <!-- First-time user hint -->
        @if (showFirstTimeHint)
        {
            <div class="first-time-hint">
                <div class="hint-content">
                    <span class="hint-icon">👆</span>
                    <span class="hint-text">Tap or drag to flip!</span>
                </div>
            </div>
        }
        
        <div @ref="coinElement" 
             class="coin @flipResult @(isDragging ? "dragging" : "") @(isSuperFlipReady ? "super-flip-ready shake" : "")" 
             @onclick="HandleClick"
             @onpointerdown="OnPointerDown"
             style="@GetCoinTransform()">
            <div class="coin-face @(showLandingFlash ? "landing-flash" : "")">
                <div class="coin-shine" style="@GetShineTransform()"></div>
                <div class="coin-inner-ring"></div>
                <img src="@faceShowing" alt="Coin" draggable="false" />
            </div>
        </div>
    </div>
    
    <!-- Control Buttons - Mobile (Bottom) - Hidden on desktop -->
    <div class="control-buttons-mobile">
        <button class="control-btn" @onclick="ToggleSound" title="@(isSoundEnabled ? "Sound On" : "Sound Off")">
            @if (isSoundEnabled)
            {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                </svg>
            }
            else
            {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <line x1="23" y1="9" x2="17" y2="15"></line>
                    <line x1="17" y1="9" x2="23" y2="15"></line>
                </svg>
            }
        </button>
        <button class="control-btn @(!isHapticsSupported ? "has-warning" : "")" @onclick="ToggleHaptics" title="@(isHapticsEnabled ? "Haptics On" : "Haptics Off")">
            @if (!isHapticsSupported)
            {
                <span class="warning-badge">!</span>
            }
            @if (isHapticsEnabled)
            {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 3v18h6l6-6V9L9 3H3z"></path>
                    <path d="M21 12c0-2.5-1-4.5-3-6"></path>
                    <path d="M18 12c0-1.5-.5-2.5-1.5-3.5"></path>
                </svg>
            }
            else
            {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 3v18h6l6-6V9L9 3H3z"></path>
                    <line x1="23" y1="9" x2="17" y2="15"></line>
                    <line x1="17" y1="9" x2="23" y2="15"></line>
                </svg>
            }
        </button>
        <a class="control-btn" href="https://github.com/jwp528/Coin-Flip-Game" target="_blank" rel="noopener noreferrer" title="View on GitHub">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
        </a>
        <button class="control-btn" @onclick="OpenAboutModal" title="About">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        </button>
    </div>
    
    <!-- Developer Credit Footer -->
    <div class="developer-credit">
        <span class="credit-text">Developed By:</span>
        <a href="https://www.joshparsons.ca" target="_blank" rel="noopener noreferrer" class="developer-link">
            <img src="/img/coins/logo.png" alt="JP Logo" class="developer-logo" />
            <span class="developer-name">Josh Parsons</span>
        </a>
    </div>
</div>

<!-- Coin Drawer - Bottom Sheet -->
<CoinDrawer 
    IsVisible="@showCoinSelector" 
    Side="@selectingFor"
    AvailableCoins="@availableCoins"
    SelectedCoinPath="@(selectingFor == "heads" ? selectedHeadsImage : selectedTailsImage)"
    IsRandomSelected="@(selectingFor == "heads" ? isHeadsRandom : isTailsRandom)"
    OnClose="@CloseCoinSelector"
    OnCoinSelected="@SelectCoin"
    OnRandomSelected="@SelectRandomOption"
    OnCoinLongPress="@HandleCoinLongPress" />

<!-- Coin Preview Modal -->
<CoinPreviewModal 
    IsVisible="@showCoinPreview"
    CoinImage="@previewCoin"
    OnClose="@CloseCoinPreview" />

<!-- About Modal -->
<AboutModal 
    IsVisible="@showAboutModal"
    OnClose="@CloseAboutModal"
    OnDataCleared="@HandleDataCleared" />

<!-- Haptic Not Supported Modal -->
<HapticNotSupportedModal 
    IsVisible="@showHapticNotSupportedModal"
    OnClose="@CloseHapticNotSupportedModal"
    UserAgent="@userAgent" />

<!-- Passive Coin Unlock Notification - Bottom of Screen -->
@if (showUnlockAchievement && currentlyUnlockedCoin != null)
{
    <div class="coin-unlock-notification @GetRarityClass(currentlyUnlockedCoin.UnlockCondition?.Rarity ?? UnlockRarity.Common)" 
         @onclick="() => OpenUnlockedCoinPreview()">
        <span class="coin-unlock-sparkle">✨</span>
        <div class="coin-unlock-icon-wrapper">
            <img src="@currentlyUnlockedCoin.Path" alt="@currentlyUnlockedCoin.DisplayName" class="coin-unlock-icon" />
        </div>
        <div class="coin-unlock-content">
            <div class="coin-unlock-label">Coin Unlocked!</div>
            <div class="coin-unlock-name">@currentlyUnlockedCoin.DisplayName</div>
        </div>
        <span class="coin-unlock-sparkle">✨</span>
    </div>
}

<script>
    window.coinDragHandler = {
        coinElement: null,
        
        startDrag: function() {
            this.coinElement = document.querySelector('.coin');
            if (this.coinElement) {
                // Remove any existing transitions for immediate response
                this.coinElement.style.transition = 'none';
            }
        },
        
        updateTransform: function(rotationX, rotationY) {
            if (this.coinElement && !this.coinElement.classList.contains('flip-heads') && !this.coinElement.classList.contains('flip-tails')) {
                // Use requestAnimationFrame for smooth, synchronized updates
                requestAnimationFrame(() => {
                    if (this.coinElement) {
                        this.coinElement.style.transform = `rotateX(${rotationX.toFixed(2)}deg) rotateY(${rotationY.toFixed(2)}deg)`;
                    }
                });
            }
        },
        
        resetTransform: function() {
            if (this.coinElement) {
                // Re-enable transitions for smooth return to neutral
                this.coinElement.style.transition = 'transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
                this.coinElement.style.transform = 'rotateX(0deg) rotateY(0deg)';
            }
        },
        
        clearTransform: function() {
            if (this.coinElement) {
                // Clear inline styles completely to return to neutral
                this.coinElement.style.transform = '';
                this.coinElement.style.transition = '';
            }
        },
        
        startShake: function() {
            this.coinElement = document.querySelector('.coin');
            if (this.coinElement) {
                // The shake animation is handled by CSS classes
                // This function is just to ensure we have the element reference
            }
        }
    };
</script>
