@page "/"
@using CoinFlipGame.App.Models
@using CoinFlipGame.App.Models.Unlocks

<HeadContent>
    <title>Coin Flip Game</title>
</HeadContent>

<div class="coin-flip-game" 
     @onpointermove="OnPointerMove"
     @onpointerup="OnPointerUp"
     @onpointercancel="OnPointerCancel">
    
    <!-- Mobile Game Style Stats -->
    <div class="stats-container">
        <!-- Heads Counter - Top Left -->
        <div class="stat-counter heads-counter" @onclick='() => OpenCoinSelector("heads")'>
            <img src="@selectedHeadsImage" alt="Heads" class="counter-icon" />
            <span class="counter-value">@headsCount</span>
        </div>
        
        <!-- Tails Counter - Top Right -->
        <div class="stat-counter tails-counter" @onclick='() => OpenCoinSelector("tails")'>
            <img src="@selectedTailsImage" alt="Tails" class="counter-icon" />
            <span class="counter-value">@tailsCount</span>
        </div>
        
        <!-- Streak Counter - Top Center -->
        @if (currentStreak > 2)
        {
            <div class="streak-counter">
                <span class="streak-icon">🔥</span>
                <span class="streak-value">@currentStreak</span>
            </div>
        }
    </div>
    
    <!-- Main Coin Container -->
    <div class="coin-container">
        <div class="coin-glow"></div>
        <div @ref="coinElement" 
             class="coin @flipResult @(isDragging ? "dragging" : "") @(isSuperFlipReady ? "super-flip-ready shake" : "")" 
             @onclick="HandleClick"
             @onpointerdown="OnPointerDown"
             style="@GetCoinTransform()">
            <div class="coin-face @(showLandingFlash ? "landing-flash" : "")">
                <div class="coin-shine" style="@GetShineTransform()"></div>
                <div class="coin-inner-ring"></div>
                <img src="@faceShowing" alt="Coin" draggable="false" />
            </div>
        </div>
    </div>
</div>

<!-- Coin Selector Modal -->
<CoinSelector 
    IsVisible="@showCoinSelector" 
    Side="@selectingFor"
    AvailableCoins="@availableCoins"
    SelectedCoinPath="@(selectingFor == "heads" ? selectedHeadsImage : selectedTailsImage)"
    IsRandomSelected="@(selectingFor == "heads" ? isHeadsRandom : isTailsRandom)"
    OnClose="@CloseCoinSelector"
    OnCoinSelected="@SelectCoin"
    OnRandomSelected="@SelectRandomOption" />

<!-- Passive Coin Unlock Notification - Bottom of Screen -->
@if (showUnlockAchievement && currentlyUnlockedCoin != null)
{
    <div class="coin-unlock-notification @GetRarityClass(currentlyUnlockedCoin.UnlockCondition?.Rarity ?? UnlockRarity.Common)" 
         @onclick="DismissUnlockAchievement">
        <span class="coin-unlock-sparkle">✨</span>
        <div class="coin-unlock-icon-wrapper">
            <img src="@currentlyUnlockedCoin.Path" alt="@currentlyUnlockedCoin.DisplayName" class="coin-unlock-icon" />
        </div>
        <div class="coin-unlock-content">
            <div class="coin-unlock-label">Coin Unlocked!</div>
            <div class="coin-unlock-name">@currentlyUnlockedCoin.DisplayName</div>
        </div>
        <span class="coin-unlock-sparkle">✨</span>
    </div>
}

<script>
    window.coinDragHandler = {
        coinElement: null,
        
        startDrag: function() {
            this.coinElement = document.querySelector('.coin');
            if (this.coinElement) {
                // Remove any existing transitions for immediate response
                this.coinElement.style.transition = 'none';
            }
        },
        
        updateTransform: function(rotationX, rotationY) {
            if (this.coinElement && !this.coinElement.classList.contains('flip-heads') && !this.coinElement.classList.contains('flip-tails')) {
                // Use requestAnimationFrame for smooth, synchronized updates
                requestAnimationFrame(() => {
                    if (this.coinElement) {
                        this.coinElement.style.transform = `rotateX(${rotationX.toFixed(2)}deg) rotateY(${rotationY.toFixed(2)}deg)`;
                    }
                });
            }
        },
        
        resetTransform: function() {
            if (this.coinElement) {
                // Re-enable transitions for smooth return to neutral
                this.coinElement.style.transition = 'transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
                this.coinElement.style.transform = 'rotateX(0deg) rotateY(0deg)';
            }
        },
        
        clearTransform: function() {
            if (this.coinElement) {
                // Clear inline styles completely to return to neutral
                this.coinElement.style.transform = '';
                this.coinElement.style.transition = '';
            }
        },
        
        startShake: function() {
            this.coinElement = document.querySelector('.coin');
            if (this.coinElement) {
                // The shake animation is handled by CSS classes
                // This function is just to ensure we have the element reference
            }
        }
    };
</script>
